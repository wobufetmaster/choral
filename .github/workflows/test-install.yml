name: Installation Tests

on:
  pull_request:
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'install.sh'
      - 'tests/install/**'
  workflow_dispatch:

jobs:
  test-installation:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [ubuntu, debian, wsl2]
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -f tests/install/dockerfiles/${{ matrix.platform }}.Dockerfile \
            -t choral-test-${{ matrix.platform }} .

      - name: Run installation
        run: |
          docker run --name install-container choral-test-${{ matrix.platform }} \
            bash -c "./install.sh"

      - name: Commit installed state
        run: |
          docker commit install-container choral-test-${{ matrix.platform }}-installed
          docker rm -f install-container

      - name: Test server startup
        run: |
          docker run --name server-container -d choral-test-${{ matrix.platform }}-installed \
            bash -c "npm run dev:server"
          sleep 5
          docker exec server-container bash -c "curl -s http://localhost:3000 > /dev/null"
          docker stop server-container
          docker rm -f server-container

      - name: Test frontend build
        run: |
          docker run --name build-container choral-test-${{ matrix.platform }}-installed \
            bash -c "npm run build"
          docker run --rm choral-test-${{ matrix.platform }}-installed \
            bash -c "test -d dist"
          docker rm -f build-container

      - name: Cleanup
        if: always()
        run: |
          docker rm -f install-container 2>/dev/null || true
          docker rm -f server-container 2>/dev/null || true
          docker rm -f build-container 2>/dev/null || true
          docker rmi choral-test-${{ matrix.platform }} 2>/dev/null || true
          docker rmi choral-test-${{ matrix.platform }}-installed 2>/dev/null || true
